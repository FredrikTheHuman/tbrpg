<!doctype html>
<meta charset="utf-8">
<title>TBRPG – lobby test</title>
<style>
  body { font-family:sans-serif; display:flex; flex-direction:column;
         align-items:center; margin:20px; }
  #map { display:grid; gap:2px; margin-top:16px; }
  .tile { width:48px; height:48px; border:1px solid #888;
          display:flex; justify-content:center; align-items:center;
          font-size:10px; position:relative; cursor:pointer; }
  .tile.village { background:#ffe; }
  .tile.you     { outline:3px solid #000; }
  .dot { width:10px; height:10px; border-radius:50%;
         position:absolute; bottom:3px; right:3px; }
  .dot.stack { right:auto; left:3px; }
</style>

<h1>TBRPG – lobby test</h1>

<label>Name:
  <input id="nameBox" placeholder="your name">
</label>
<button id="joinBtn">Join world</button>

<h2 id="onlineHdr" hidden>Players online:</h2>
<ul id="onlineList"></ul>

<!-- grid map -->
<div id="map"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
const sock        = io();
const nameBox     = document.getElementById('nameBox');
const joinBtn     = document.getElementById('joinBtn');
const onlineHdr   = document.getElementById('onlineHdr');
const onlineList  = document.getElementById('onlineList');
const mapDiv      = document.getElementById('map');

let myId = null;
let lastState = null;

/* ---------- join ---------- */
joinBtn.addEventListener('click', () => {
  const n = nameBox.value.trim();
  if (!n) return alert('Pick a name first!');
  sock.emit('join', { name: n });
  joinBtn.disabled = nameBox.disabled = true;
});

/* ---------- player list ---------- */
function renderList(players) {
  onlineList.innerHTML = '';
  Object.values(players).forEach(p => {
    const li = document.createElement('li');
    li.textContent = p.name;
    li.style.color = p.color;
    onlineList.appendChild(li);
  });
  onlineHdr.hidden = onlineList.children.length === 0;
}

/* ---------- map ---------- */
function drawMap(state) {
  if (!state) return;
  const me = state.players[myId];
  if (!me) return;

  const SIZE = 15;                // 15×15 viewport
  const R    = Math.floor(SIZE/2);
  mapDiv.style.gridTemplateColumns = `repeat(${SIZE},48px)`;
  mapDiv.innerHTML = '';

  for (let y = me.y - R; y <= me.y + R; y++) {
    for (let x = me.x - R; x <= me.x + R; x++) {
      const tileData = state.tiles[`${x},${y}`] || { type:'wilderness' };
      const div = document.createElement('div');
      div.className = 'tile ' + (tileData.type === 'village' ? 'village' : '');
      div.dataset.x = x;
      div.dataset.y = y;

      // centre indicator
      if (x === 0 && y === 0) div.textContent = 'village';

      // players in this tile
      const here = Object.values(state.players).filter(p => p.x === x && p.y === y);
      here.forEach((p,i) => {
        const dot = document.createElement('div');
        dot.className = 'dot' + (i ? ' stack' : '');
        dot.style.background = p.color;
        div.appendChild(dot);
        if (p.id === myId) div.classList.add('you');
      });

      div.onclick = () => {
        // allow click only if adjacent
        const dx = Math.abs(x - me.x);
        const dy = Math.abs(y - me.y);
        if (dx + dy === 1) sock.emit('moveTo', { x, y });
      };
      mapDiv.appendChild(div);
    }
  }
}

/* ---------- socket events ---------- */
sock.on('connect', () => { myId = sock.id; });

sock.on('state', state => {
  lastState = state;
  renderList(state.players);
  drawMap(state);
});
</script>

