<!doctype html>
<meta charset="utf-8">
<title>TBRPG – co-op demo</title>
<style>
 :root{--tile:48px}
 body{font-family:sans-serif;margin:0;display:flex;flex-direction:column;
       align-items:center;background:#f3f3f8}
 h1{margin:16px 0}
 #mapView{display:none;gap:24px}
 #summary{min-width:190px}
 #map{display:grid;gap:2px}
 .tile{width:var(--tile);height:var(--tile);border:1px solid #888;
       display:flex;justify-content:center;align-items:center;font-size:10px;
       position:relative;cursor:pointer}
 .wilderness{background:#fee} .cleared{background:#cfc} .village{background:#ffd}
 .you{outline:3px solid #000}
 .dot{width:10px;height:10px;border-radius:50%;position:absolute;bottom:3px;right:3px}
 .dot.stack{right:auto;left:3px}
 /* battle */
 #battleView{display:none;flex-direction:column;align-items:center;width:100%}
 #arena{display:flex;gap:40px;margin-top:20px}
 .card{background:#fff;padding:20px 26px;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.1);text-align:center;width:260px}
 .bar{height:18px;background:#e0e0e0;border-radius:9px;overflow:hidden;margin-top:6px}
 .bar>.fill{height:100%;background:#4caf50}
 #controls button{margin:4px 6px;padding:8px 16px;border:0;border-radius:8px;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,.12)}
 button[disabled]{opacity:.4;cursor:not-allowed}
 #log{width:540px;height:180px;margin-top:8px;resize:none;overflow:auto;
      font-family:monospace;font-size:12px;border:1px solid #aaa;border-radius:4px}
 #villageView{display:none;flex-direction:column;align-items:center;width:100%}
 #villageView h2{margin:12px 0 4px}
 #villageInner{background:#fff;padding:20px 28px;border-radius:12px;
               box-shadow:0 4px 10px rgba(0,0,0,.2);text-align:center}
 #vPop{font-size:24px;margin:6px 0}
 #shop button{margin:4px 6px;padding:6px 12px;border:0;border-radius:8px;cursor:pointer}
</style>

<h1>TBRPG – lobby test</h1>
<label>Name:<input id="nameBox" placeholder="your name"></label>
<button id="joinBtn">Join world</button>

<!-- ── MAP VIEW ───────────────────────────────── -->
<div id="mapView">
  <div id="summary">
    <h3>You</h3><div id="sumBox">—</div>
    <h3>Players online</h3><ul id="onlineList"></ul>
  </div>
  <div id="map"></div>
</div>

<!-- ── BATTLE VIEW ────────────────────────────── -->
<div id="battleView">
  <div id="arena">
    <div class="card">
      <h2 id="pName">Hero</h2>
      <div class="bar"><div id="pHp" class="fill"></div></div>
      <p id="pStats"></p>
    </div>
    <div class="card">
      <h2 id="eName">Enemy</h2>
      <div class="bar"><div id="eHp" class="fill"></div></div>
      <p id="eStats"></p>
    </div>
  </div>

  <div id="controls">
    <button id="attackBtn">Attack</button>
    <button id="nextBtn"  disabled>Next Enemy</button>
    <button id="leaveBtn" disabled>Leave</button>
  </div>
  <textarea id="log" readonly></textarea>
</div>

<!-- ▶ NEW VILLAGE VIEW -->
<div id="villageView">
  <div id="villageInner">
    <h2>The Village</h2>
    <div id="vPop">Pop 100</div>
    <p id="vDesc">(A sleepy hamlet surrounded by wilderness.)</p>

    <h3>Church</h3>
    <button id="healBtn">Heal (1 g / lvl)</button>
    <button id="herbBtn">Eat random herbs (+1 HP)</button>

    <h3>Smithy</h3>
    <div id="shop"></div>

    <h3>Players in village</h3>
    <ul id="villageList"></ul>

    <br><button id="leaveVillage">Leave village</button>
  </div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
/* ========== Socket & global state ========== */
const sock=io();
let myId=null,state=null;
const weaponTiers=['Wooden Club','Stone Knife','Bronze Dagger','Iron Sword'];
const armorTiers =['Cloth Tunic','Padded Vest','Leather Armor','Chain Shirt']
/* ---------- player local stats ---------- */
const meStats={ level:1,xp:0,gold:0,
  get hpMax(){return Math.round(100+10*(this.level-1)+1.4**this.level)},
  get atk  (){return Math.round(10+ 2*(this.level-1)+1.2**this.level)},
  hp:100
};
function gain(xp,gold){
  meStats.xp+=xp; meStats.gold+=gold;
  while(meStats.xp >= Math.round(20 + 5 * meStats.level + 1.2 ** meStats.level)){
    meStats.xp-=meStats.level*25; meStats.level++;
    meStats.hp=meStats.hpMax;
    addLog(`*** Level up! Now Lv ${meStats.level}\n`);
  }
}

/* ---------- DOM refs ---------- */
const mapView=document.getElementById('mapView');
const mapDiv=document.getElementById('map');
const sumBox=document.getElementById('sumBox');
const onlineUl=document.getElementById('onlineList');
const battleView=document.getElementById('battleView');
const pName=document.getElementById('pName');
const pHp=document.getElementById('pHp');
const pStats=document.getElementById('pStats');
const eName=document.getElementById('eName');
const eHp=document.getElementById('eHp');
const eStats=document.getElementById('eStats');
const attackBtn=document.getElementById('attackBtn');
const nextBtn=document.getElementById('nextBtn');
const leaveBtn=document.getElementById('leaveBtn');
const logBox=document.getElementById('log');
const villageView=document.getElementById('villageView');
const vPop=document.getElementById('vPop');
const vDesc=document.getElementById('vDesc');
const villageList=document.getElementById('villageList');
const shopDiv=document.getElementById('shop');
const desc=[
  [0,199,'A sleepy hamlet surrounded by wilderness.'],
  [200,499,'A growing village with fresh wooden palisades.'],
  [500,999,'A bustling town, smoke rising from many chimneys.'],
  [1000,99999,'A thriving city with stone walls and busy markets.']
];
function addLog(t){logBox.value+=t;logBox.scrollTop=logBox.scrollHeight;}

/* ---------- join ---------- */
document.getElementById('joinBtn').onclick=()=>{
  const n=document.getElementById('nameBox').value.trim();
  if(!n)return alert('Pick a name!');
  sock.emit('join',{name:n});
  document.getElementById('joinBtn').disabled=
  document.getElementById('nameBox').disabled=true;
  mapView.style.display='flex';
};

/* ---------- map drawing ---------- */
const SIZE=15,R=Math.floor(SIZE/2);
function refreshSidebar(){
  sumBox.innerHTML=
   `HP <b>${meStats.hp}</b> / ${meStats.hpMax}<br>
    ATK <b>${meStats.atk}</b><br>
    Gold <b>${meStats.gold}</b><br>
    Lv <b>${meStats.level}</b> XP ${meStats.xp}/${meStats.level*25}`;
  onlineUl.innerHTML='';
  Object.values(state.players).forEach(p=>{
    const li=document.createElement('li');li.textContent=p.name;li.style.color=p.color;
    onlineUl.appendChild(li);
  });
}
function drawMap(){
  const me=state.players[myId]; if(!me)return;
  mapDiv.style.gridTemplateColumns=`repeat(${SIZE},var(--tile))`;
  mapDiv.innerHTML='';
  for(let y=me.y-R;y<=me.y+R;y++){
    for(let x=me.x-R;x<=me.x+R;x++){
      const k=`${x},${y}`;const t=state.tiles[k]||{type:'wilderness',monstersRemaining:0};
      const d=document.createElement('div');
      d.className=`tile ${t.type}${t.cleared?' cleared':' wilderness'}`;
      if(x===0&&y===0)d.textContent='village';
      const ps=Object.values(state.players).filter(p=>p.x===x&&p.y===y);
      ps.forEach((p,i)=>{const dot=document.createElement('div');dot.className='dot'+(i?' stack':'');dot.style.background=p.color;d.appendChild(dot);if(p.id===myId)d.classList.add('you')});
      if(t.monstersRemaining&&!t.cleared&&x===me.x&&y===me.y)
        d.title=`${t.monstersRemaining} monsters`;
      d.onclick=()=>{
        const adj=Math.abs(x-me.x)+Math.abs(y-me.y);
        if(adj===1) sock.emit('moveTo',{x,y});
        else if(x===me.x&&y===me.y&&t.monstersRemaining) startBattle(x,y,t.monstersRemaining);
      };
      mapDiv.appendChild(d);
    }
  }
}

/* ---------- battle ---------- */
let tileX,tileY,monstersLeft,enemy;
function startBattle(x,y,count){
  tileX=x;tileY=y;monstersLeft=count;logBox.value='';
  mapView.style.display='none';battleView.style.display='flex';
  nextBtn.disabled=leaveBtn.disabled=true; attackBtn.disabled=true;
  pName.textContent=state.players[myId].name;
  updateHeroBar();
  sock.emit('requestEnemy',{x,y});
}
function updateHeroBar(){
  pHp.style.width=Math.round(meStats.hp/meStats.hpMax*100)+'%';
  pStats.textContent=`HP ${meStats.hp}/${meStats.hpMax} | ATK ${meStats.atk}`;
}
sock.on('enemyData',e=>{
  enemy={...e,maxHp:e.hp};
  eName.textContent=enemy.name;
  eHp.style.width='100%';
  eStats.textContent=`HP ${enemy.hp} | ATK ${enemy.atk}`;
  addLog(`A ${enemy.name} appears!\n`);
  attackBtn.disabled=false;
});
attackBtn.onclick=()=>{
  /* player hit */
  const pdmg=Math.floor(Math.random()*meStats.atk)+1;
  enemy.hp=Math.max(enemy.hp-pdmg,0);
  eHp.style.width=Math.round(enemy.hp/enemy.maxHp*100)+'%';
  addLog(`You hit for ${pdmg}\n`);
  if(enemy.hp===0){victory();return;}
  /* enemy hit */
  const edmg=Math.floor(Math.random()*enemy.atk)+1;
  meStats.hp=Math.max(meStats.hp-edmg,0);
  updateHeroBar();
  addLog(`${enemy.name} hits for ${edmg}\n`);
  if(meStats.hp===0){addLog('*** You were defeated! Respawning…\n');sock.emit('respawn');meStats.hp=meStats.hpMax;endBattle();return;}
};
function victory(){
  attackBtn.disabled=true;
  addLog(`*** Defeated ${enemy.name}! (+${enemy.xp} XP, +${enemy.gold}g)\n`);
  gain(enemy.xp,enemy.gold); refreshSidebar();
  sock.emit('enemyDefeated',{x:tileX,y:tileY});
  monstersLeft--;
  if(monstersLeft>0){nextBtn.disabled=false;leaveBtn.disabled=false;}
  else {leaveBtn.disabled=false;}
}
nextBtn.onclick=()=>{nextBtn.disabled=true;attackBtn.disabled=true;sock.emit('requestEnemy',{x:tileX,y:tileY});};
leaveBtn.onclick=endBattle;
function endBattle(){
  battleView.style.display='none';mapView.style.display='flex';
}
function openVillage(){
  villageView.style.display='flex'; mapView.style.display='none';
  battleView.style.display='none';
  sock.emit('enterVillage');
}
document.getElementById('leaveVillage').onclick=()=>{villageView.style.display='none';mapView.style.display='flex';sock.emit('leaveVillage');};

/* church buttons */
document.getElementById('healBtn').onclick=()=>sock.emit('healAtChurch');
sock.on('healed',()=>{meStats.hp=meStats.hpMax;refreshSidebar();});
document.getElementById('herbBtn').onclick=()=>{if(meStats.hp<meStats.hpMax){meStats.hp++;refreshSidebar();}}

/* ---------- shop render (very simple) ------------ */
function rebuildShop(pop){
  shopDiv.innerHTML='';
  const tier=Math.min(Math.floor(pop/250),weaponTiers.length-1); // unlock every 250 pop
  const w=weaponTiers[tier], a=armorTiers[tier];
  const bw=document.createElement('button');bw.textContent=`Buy ${w} (5g)`;shopDiv.appendChild(bw);
  const ba=document.createElement('button');ba.textContent=`Buy ${a} (5g)`;shopDiv.appendChild(ba);
}

sock.on('state',s=>{
  state=s; if(myId){refreshSidebar();drawMap();}
  if(s.village){
    const pop=s.village.population;
    vPop.textContent=`Pop ${pop} (${ (1/ (clearedTiles()*0.01||0.01)).toFixed(1)} s/+1)`;
    const d=desc.find(r=>pop>=r[0]&&pop<=r[1]); if(d)vDesc.textContent=d[2];
    rebuildShop(pop);
    // list players inside
    villageList.innerHTML='';
    Object.values(s.players).filter(p=>p.inVillage).forEach(p=>{
      const li=document.createElement('li');li.textContent=p.name;li.style.color=p.color;villageList.appendChild(li);
    });
  }
});
function clearedTiles(){let n=0;for(const t of Object.values(state.tiles))if(t.cleared)n++;return n;}

/* ---------- socket updates ---------- */
sock.on('state',s=>{state=s;if(myId){refreshSidebar();drawMap();}});

sock.on('connect',()=>{myId=sock.id});
</script>

